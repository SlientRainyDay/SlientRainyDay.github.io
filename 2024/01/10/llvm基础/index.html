<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>llvm基础 |  Rain&#39;s Blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-llvm基础"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  llvm基础
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/01/10/llvm%E5%9F%BA%E7%A1%80/" class="article-date">
  <time datetime="2024-01-10T13:52:48.000Z" itemprop="datePublished">2024-01-10</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/llvm/">llvm</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">5.2k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">20 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="LLVM基础"><a href="#LLVM基础" class="headerlink" title="LLVM基础"></a>LLVM基础</h1><blockquote>
<p>此部分主要涉及基本概念、环境搭建及LLVM IR的基本指令</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a target="_blank" rel="noopener" href="https://llvm.org/">llvm官网</a>（点击）</p>
<h3 id="代码混淆"><a href="#代码混淆" class="headerlink" title="代码混淆"></a>代码混淆</h3><p>定义：代码混淆是将计算机程序的代码，转换成一种功能上等价，但是难以阅读和理解的形式的行为。</p>
<span id="more"></span>



<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153142.png" alt="image-20230505204155595"></p>
<p>代码执行由顺序图转为分发器控制，使难以分清原来程序的逻辑。</p>
<h3 id="学习混淆的意义"><a href="#学习混淆的意义" class="headerlink" title="学习混淆的意义"></a>学习混淆的意义</h3><p>对于软件开发者：一定程度上防止代码被逆向破解</p>
<p>对于逆向工程师：帮助我们研究反混淆技术</p>
<h2 id="LLVM环境搭建"><a href="#LLVM环境搭建" class="headerlink" title="LLVM环境搭建"></a>LLVM环境搭建</h2><p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202305061505271.png" alt="image-20230506145141902"></p>
<h3 id="第一步：下载-LLVM-Core-和-Clang源代码"><a href="#第一步：下载-LLVM-Core-和-Clang源代码" class="headerlink" title="第一步：下载 LLVM-Core 和 Clang源代码"></a>第一步：下载 LLVM-Core 和 Clang源代码</h3><blockquote>
<p>首先应安装c++环境，安装cmake。<br><a target="_blank" rel="noopener" href="https://dua0g.top/archives/366">安装C++</a><br><a target="_blank" rel="noopener" href="https://dua0g.top/archives/364">安装cmake</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/llvm/llvm-project/releases/tag/llvmorg-12.0.1">https://github.com/llvm/llvm-project/releases/tag/llvmorg-12.0.1</a></p>
<p>下载 LLVM-Core 和 Clang 源代码：</p>
<ul>
<li>llvm-12.0.1.src.tar.xz</li>
<li>clang-12.0.1.src.tar.xz</li>
</ul>
<p>在 &#x2F;home&#x2F;llvm&#x2F;Programs 文件夹内创建 llvm-project 文件夹，存放我们刚刚下载的源码压缩包。</p>
<p>将两个压缩包解压之后改名为 llvm 和 clang ，方便后续使用。</p>
<p>在同一文件夹内创建名为 build 的文件夹，存放编译后的LLVM</p>
<p>此时的目录结构如下(笔者的ubuntu为中文，用户文件夹即为home)：</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153837.png" alt="image-20230508005613030"></p>
<h3 id="第二步：新建build-sh文件并编译"><a href="#第二步：新建build-sh文件并编译" class="headerlink" title="第二步：新建build.sh文件并编译"></a>第二步：新建<code>build.sh</code>文件并编译</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim build.sh</span><br></pre></td></tr></table></figure>

<p>在sh文件内写入如下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd build</span><br><span class="line">cmake -G &quot;Unix Makefiles&quot; -DLLVM_ENABLE_PROJECTS=&quot;clang&quot; \</span><br><span class="line">-DCMAKE_BUILD_TYPE=Release -DLLVM_TARGETS_TO_BUILD=&quot;X86&quot; \</span><br><span class="line">-DBUILD_SHARED_LIBS=On ../llvm</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>cmake 参数解释：</p>
<p>—G “Unix Makefiles”：生成Unix下的Makefile</p>
<p>—DLLVM_ENABLE_PROJECTS&#x3D;“clang”：除了 LLVM Core 外，还需要编译的子项目。</p>
<p>—DLLVM_BUILD_TYPE&#x3D;Release：在cmake里，有四种编译模式：Debug, Release,RelWithDebInfo和MinSizeRel。使用 Release 模式编译会节省很多空间。</p>
<p>—DLLVM_TARGETS_TO_BUILD&#x3D;“X86”：默认是ALL，选择X86可节约很多编译时间。</p>
<p>—DBUILD_SHARED_LIBS&#x3D;On：指定动态链接 LLVM 的库，可以节省空间。</p>
<p>make install 指令是将编译好的二进制文件和头文件等安装到本机的 &#x2F;usr&#x2F;local&#x2F;bin和 &#x2F;usr&#x2F;local&#x2F;include 目录，方便后续使用。</p>
<p>执行 build.sh 文件自动安装和编译，编译时长从十多分钟到数小时，具体时间由机器性能决定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./build.sh</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153073.png" alt="image-20230613002255183"></p>
<p>输入 clang -v确认编译和安装是否完成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -v</span><br></pre></td></tr></table></figure>

<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306131207728.png" alt="image-20230613120735663"></p>
<h2 id="LLVM基本用法"><a href="#LLVM基本用法" class="headerlink" title="LLVM基本用法"></a>LLVM基本用法</h2><p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202305061451936.png" alt="image-20230506145141902"></p>
<h3 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h3><blockquote>
<p>代码混淆是基于优化器进行的。</p>
</blockquote>
<h4 id="1-将源代码转换为中间代码LLVM-IR"><a href="#1-将源代码转换为中间代码LLVM-IR" class="headerlink" title="1.将源代码转换为中间代码LLVM IR"></a>1.将源代码转换为中间代码LLVM IR</h4><blockquote>
<p>由前端Clang将源代码转化为LLVM IR 代码</p>
</blockquote>
<p>LLVM IR主要有两种表现形式：</p>
<ul>
<li>人类可阅读的文本形式，对应后缀为.ll</li>
<li>方便机器处理的二进制文本，对应后缀为.bc</li>
</ul>
<p>将源代码转化为以上两种LLVM IR代码的命令分别如下：</p>
<p>可阅读文本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -S -emit-llvm 文件名.cpp -o 文件名.ll</span><br></pre></td></tr></table></figure>

<p>二进制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -c -emit-llvm 文件名.cpp -o 文件名.bc</span><br></pre></td></tr></table></figure>

<p>以上两种后缀的文件后续均可以被优化和被编译成可执行文件</p>
<h4 id="2-由优化器将对中间代码进行优化，得到优化后的中间代码。"><a href="#2-由优化器将对中间代码进行优化，得到优化后的中间代码。" class="headerlink" title="2.由优化器将对中间代码进行优化，得到优化后的中间代码。"></a>2.由优化器将对中间代码进行优化，得到优化后的中间代码。</h4><blockquote>
<p>使用opt指令对LLVM IR进行优化，opt为optimizer即优化器的缩写</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt -load LLVMObfuscator.so -hlw -S 文件名.ll -o 文件名_opt.ll</span><br></pre></td></tr></table></figure>

<ul>
<li>-load 加载指定的LLVM Pass集合进行优化（通常为.so文件）</li>
<li>-hlw 是LLVM Pass中自定义的参数，用来指定使用哪个Pass文件进行优化</li>
<li>-S和第一步的意义相同，为指定生成可阅读文本</li>
</ul>
<h4 id="3-由后端将中间代码转化为目标平台的机器代码，机器代码到可执行文件"><a href="#3-由后端将中间代码转化为目标平台的机器代码，机器代码到可执行文件" class="headerlink" title="3.由后端将中间代码转化为目标平台的机器代码，机器代码到可执行文件"></a>3.由后端将中间代码转化为目标平台的机器代码，机器代码到可执行文件</h4><blockquote>
<p>calng将如上两步整合为了一步，省去了链接器的过程(直接生成了可执行文件)</p>
</blockquote>
<p> 通过clang完成生成可执行文件的过程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clnag 文件名_opt.ll -o 文件名</span><br></pre></td></tr></table></figure>



<h2 id="编写LLVM-Pass"><a href="#编写LLVM-Pass" class="headerlink" title="编写LLVM Pass"></a>编写LLVM Pass</h2><blockquote>
<p>基于 <strong>LLVM Pass框架</strong>进行编写。</p>
</blockquote>
<blockquote>
<p>优化器 opt 和 LLVM Pass 框架是我们后续实现代码混淆的基础。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153417.png" alt="image-20230613135809578"></p>
<h3 id="LLVM-Pass的基本概念"><a href="#LLVM-Pass的基本概念" class="headerlink" title="LLVM Pass的基本概念"></a>LLVM Pass的基本概念</h3><blockquote>
<p>LLVM Pass框架功能非常强大，一些代码优化工具和fuzz(AFL)工具都是基于llvm pass框架进行开发</p>
</blockquote>
<p>LLVM Pass 框架是整个 LLVM 提供给用户用来干预代码优化过程的框架，也是我们编写代码混淆工具的基础。</p>
<p>编译后的 LLVM Pass 通过优化器 opt 进行加载，可以对 LLVM IR 中间代码进行分析和修改，生成新的中间代码。</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306131128683.png" alt="image-20230613112852652"></p>
<h3 id="LLVM-源代码目录结构"><a href="#LLVM-源代码目录结构" class="headerlink" title="LLVM 源代码目录结构"></a>LLVM 源代码目录结构</h3><p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306131358432.png" alt="image-20230613135839402"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">优化器属于llvm-core的子项目</span><br></pre></td></tr></table></figure>

<h4 id="llvm-include-llvm-文件夹"><a href="#llvm-include-llvm-文件夹" class="headerlink" title="llvm&#x2F;include&#x2F;llvm 文件夹"></a>llvm&#x2F;include&#x2F;llvm 文件夹</h4><p>存放了 LLVM 提供的一些公共头文件，这些头文件是开发过程中要用到的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153696.png" alt="image-20230613114448635"></p>
<h4 id="llvm-lib-文件夹"><a href="#llvm-lib-文件夹" class="headerlink" title="llvm&#x2F;lib 文件夹"></a>llvm&#x2F;lib 文件夹</h4><p>存放了 LLVM 大部分源代码（.cpp 文件）和一些不公开的头文件，阅读这些源代码可以深入了解llvm的运行原理</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306131354157.png" alt="image-20230613135432113"></p>
<h4 id="llvm-lib-Transforms-文件夹"><a href="#llvm-lib-Transforms-文件夹" class="headerlink" title="llvm&#x2F;lib&#x2F;Transforms 文件夹"></a>llvm&#x2F;lib&#x2F;Transforms 文件夹</h4><p>存放所有 LLVM Pass 的源代码。<br>也存放了一些 LLVM 自带的 Pass。</p>
<p>自己编写的Pass也可以放入该文件夹。</p>
<h3 id="LLVM-Pass的编写、编译及加载"><a href="#LLVM-Pass的编写、编译及加载" class="headerlink" title="LLVM Pass的编写、编译及加载"></a>LLVM Pass的编写、编译及加载</h3><p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153106.png" alt="image-20230613140257080"></p>
<h4 id="LLVM-Pass的编写-理论"><a href="#LLVM-Pass的编写-理论" class="headerlink" title="LLVM Pass的编写(理论)"></a>LLVM Pass的编写(理论)</h4><blockquote>
<p>以 “Hello world” 为例。<br>目标：编写一个 LLVM Pass，遍历程序中的所有函数，并输出 “Hello, ”+ 函数名。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153154.png" alt="image-20230613140320741"></p>
<h5 id="1-创建Pass项目"><a href="#1-创建Pass项目" class="headerlink" title="1.创建Pass项目"></a>1.创建Pass项目</h5><blockquote>
<p>CMake是一种项目管理工具，可以对各种LLVM Pass进行编写</p>
</blockquote>
<p>LLVM Pass 支持三种编译方式：</p>
<ul>
<li>第一种是与整个 LLVM 一起重新编译，Pass 代码需要存放在 llvm&#x2F;lib&#x2F;Transforms 文件夹中。（编译耗时间）</li>
<li><strong>第二种方法是通过 CMake 对 Pass 进行单独编译。</strong>（最常使用）</li>
<li>第三种方法是使用命令行对 Pass 进行单独编译。（项目越大越不好管理）</li>
</ul>
<h5 id="2-Pass类型的选择"><a href="#2-Pass类型的选择" class="headerlink" title="2.Pass类型的选择"></a>2.Pass类型的选择</h5><ul>
<li>在设计一个新的 LLVM Pass 时，最先要决定的就是选择 Pass 的类型。</li>
<li>LLVM 有多种类型的 Pass 可供选择，包括：ModulePass(基于模块)、FunctionPass(基于函数)、CallGraphPass(基于调用图)、LoopPass(基于循环)等等。</li>
</ul>
<p>本文重点学习<strong>FunctionPass</strong>，基于函数的Pass</p>
<h5 id="3-FunctionPass简介"><a href="#3-FunctionPass简介" class="headerlink" title="3.FunctionPass简介"></a>3.FunctionPass简介</h5><ul>
<li>FunctionPass 以函数为单位进行处理。</li>
<li>FunctionPass 的子类必须实现 runOnFunction(Function &amp;F) 函数。</li>
<li><strong>在 FunctionPass 运行时，会对程序中的每个函数执行runOnFunction 函数。</strong></li>
</ul>
<h5 id="4-LLVM-Pass的编写步骤"><a href="#4-LLVM-Pass的编写步骤" class="headerlink" title="4.LLVM Pass的编写步骤"></a>4.LLVM Pass的编写步骤</h5><p>1).创建一个类（class），继承 FunctionPass 父类</p>
<p>2).在创建的类中实现 runOnFunction(Function &amp;F) 函数。</p>
<p>3).向 LLVM 注册我们的 Pass 类。</p>
<h5 id="5-LLVM的编译"><a href="#5-LLVM的编译" class="headerlink" title="5.LLVM的编译"></a>5.LLVM的编译</h5><p>选择基于CMake的编译，直接使用CMake进行编译即可。</p>
<p>编译好的<code>.so</code>文件在<code>build</code>文件夹内。</p>
<h5 id="6-LLVM-Pass的加载"><a href="#6-LLVM-Pass的加载" class="headerlink" title="6.LLVM Pass的加载"></a>6.LLVM Pass的加载</h5><p>使用优化器 opt 将处理中间代码，生成新的中间代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt -load ./LLVMObfuscator.so -hlw -S hello.ll -o hello_opt.ll</span><br></pre></td></tr></table></figure>

<p>-load 加载编译好的 LLVM Pass（.so文件）进行优化</p>
<h4 id="LLVM-Pass的编写-实践"><a href="#LLVM-Pass的编写-实践" class="headerlink" title="LLVM Pass的编写(实践)"></a>LLVM Pass的编写(实践)</h4><h5 id="创建文件夹"><a href="#创建文件夹" class="headerlink" title="创建文件夹"></a>创建文件夹</h5><p>首先在虚拟机的llvm文件夹创建OLLVM++文件夹</p>
<p>在此创建如下文件夹及文件</p>
<ul>
<li><p>Build 文件夹：存放编译后 LLVM Pass</p>
</li>
<li><p>Test 文件夹：存放测试程序 TestProgram.cpp</p>
</li>
<li><p>Test&#x2F;TestProgram.cpp：一个简单的 CTF 逆向题</p>
</li>
<li><p>Transforms&#x2F;include 文件夹：存放整个 LLVM Pass 项目的头文件，暂时还没有用到</p>
</li>
<li><p>Transforms&#x2F;src 文件夹：存放整个 LLVM Pass 项目的源代码</p>
</li>
<li><p>Transforms&#x2F;src&#x2F;HelloWorld.cpp：HelloWorld Pass 的源代码，一般来说一个 Pass 使用一个 cpp 文件</p>
<p>实现即可。</p>
</li>
<li><p>Transforms&#x2F;CMakeLists.txt：整个 CMake 项目的配置文件。</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153047.png" alt="image-20230613162450704"></p>
<p>各文件内容分别如下：</p>
<p>TestProgram.cpp   将要被编译的源代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="type">char</span> input[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">char</span> enc[<span class="number">100</span>] = <span class="string">&quot;\x86\x8a\x7d\x87\x93\x8b\x4d\x81\x80\x8a\</span></span><br><span class="line"><span class="string">\x43\x7f\x49\x49\x86\x71\x7f\x62\x53\x69\x28\x9d&quot;</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">encrypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *dest, <span class="type">char</span> *src)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(src);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; len;i ++)&#123;</span><br><span class="line">        dest[i] = (src[i] + (<span class="number">32</span> - i)) ^ i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//flag&#123;s1mpl3_11vm_d3m0&#125;</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please input your flag: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, input);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> dest[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">encrypt</span>(dest, input);</span><br><span class="line">    <span class="type">bool</span> result = <span class="built_in">strlen</span>(input) == <span class="number">22</span> &amp;&amp; !<span class="built_in">memcmp</span>(dest, enc, <span class="number">22</span>);</span><br><span class="line">    <span class="keyword">if</span>(result)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Congratulations~\n&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sorry try again.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CMakeLists.txt</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 参考官方文档：https:<span class="comment">//llvm.org/docs/CMake.html#developing-llvm-passes-out-of-source</span></span><br><span class="line"><span class="built_in">project</span>(OLLVM++)                              #项目名称 OLLVM++</span><br><span class="line"><span class="built_in">cmake_minimum_required</span>(VERSION <span class="number">3.13</span><span class="number">.4</span>)      #和llvm有关的环境变量</span><br><span class="line"><span class="built_in">find_package</span>(LLVM REQUIRED CONFIG)</span><br><span class="line"></span><br><span class="line"><span class="built_in">list</span>(APPEND CMAKE_MODULE_PATH <span class="string">&quot;$&#123;LLVM_CMAKE_DIR&#125;&quot;</span>)</span><br><span class="line"><span class="built_in">include</span>(AddLLVM)</span><br><span class="line"><span class="built_in">include_directories</span>(<span class="string">&quot;./include&quot;</span>) # 包含 ./include 文件夹中的头文件</span><br><span class="line"></span><br><span class="line"><span class="built_in">separate_arguments</span>(LLVM_DEFINITIONS_LIST NATIVE_COMMAND $&#123;LLVM_DEFINITIONS&#125;)</span><br><span class="line"><span class="built_in">add_definitions</span>($&#123;LLVM_DEFINITIONS_LIST&#125;)</span><br><span class="line"><span class="built_in">include_directories</span>($&#123;LLVM_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">add_llvm_library</span>( LLVMObfuscator MODULE                 #注册LLVMObfuscator模块</span><br><span class="line">  src/HelloWorld.cpp                                    #添加项目的源代码文件</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h5 id="编写相关代码"><a href="#编写相关代码" class="headerlink" title="编写相关代码"></a>编写相关代码</h5><blockquote>
<p>具体操作在bool Demo::runOnFunction(Function &amp;F){}中实现即可。</p>
</blockquote>
<p>Hello.cpp为我们要编写的LLVM Pass代码</p>
<p>模板如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">Demo</span> : <span class="keyword">public</span> FunctionPass&#123;</span><br><span class="line">		<span class="keyword">public</span>:</span><br><span class="line">			<span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">			<span class="built_in">Demo</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line">        </span><br><span class="line">			<span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span></span>;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// runOnFunction 函数实现</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Demo::runOnFunction</span><span class="params">(Function &amp;F)</span></span>&#123;</span><br><span class="line"><span class="comment">// do something</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span> Demo::ID = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 注册该 Demo Pass</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;Demo&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;xxx&quot;</span>, <span class="string">&quot;Pass 描述.&quot;</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<p>关于此次实验代码 <code>HelloWorld.cpp</code>如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在此编写LLVM Pass的代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//导入llvm所需的头文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span>   <span class="comment">//和输入输出有关</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义我们自己的命名空间</span></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">HelloWorld</span> : <span class="keyword">public</span> FunctionPass&#123;          <span class="comment">//自定义的HelloWorld类继承FunctionPass</span></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">            <span class="built_in">HelloWorld</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;  <span class="comment">//HelloWorld的构造函数</span></span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">HelloWorld::runOnFunction</span><span class="params">(Function &amp;F)</span></span>&#123;</span><br><span class="line">    <span class="comment">//todo 对函数的分析或修改代码</span></span><br><span class="line">    <span class="built_in">outs</span>()  &lt;&lt; <span class="string">&quot;Hello,&quot;</span> &lt;&lt; F.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;         <span class="comment">//获取llvm的输出流</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> HelloWorld::ID = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;HelloWorld&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hlw&quot;</span>,<span class="string">&quot;对Pass的描述&quot;</span>)</span></span>;  <span class="comment">//注册该Pass</span></span><br></pre></td></tr></table></figure>

<p>test.sh：编译 LLVM Pass 并对 Test 文件夹中的代码进行测试(复制时把我的注释去掉)</p>
<p>在vscode控制台输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 test.sh</span><br></pre></td></tr></table></figure>

<p>然后运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./test.sh</span><br></pre></td></tr></table></figure>

<p><strong>笔者在此处遇到一个问题，第一次编译并不会在<code>Build</code>文件夹下产生<code>LLVMObfuscator.so</code>文件，需要进入<code>Transforms</code>文件夹手动进行复制到<code>Build</code>文件夹进行第二次编译。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd ./Build</span><br><span class="line">cmake ../Transforms               //对transforms的项目进行编译，得到编译后的`.so`文件</span><br><span class="line">make</span><br><span class="line">cd ../Test</span><br><span class="line">clang -S -emit-llvm TestProgram.cpp -o TestProgram.ll		//clang将源代码转换为中间代码</span><br><span class="line">opt -load ../Build/LLVMObfuscator.so -hlw -S TestProgram.ll -o TestProgram_hlw.ll  ////opt加载so文件，用hlw pass进行优化</span><br><span class="line">clang TestProgram_hlw.ll -o TestProgram_hlw     //将优化后的中间代码编译为可执行文件</span><br><span class="line">./TestProgram_hlw						  //运行可执行文件</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153549.png" alt="image-20230614214141654"></p>
<p>实现了对样本程序中的每个函数进行扫描，并输出了”Hello,”+函数名</p>
<h2 id="CMake学习"><a href="#CMake学习" class="headerlink" title="CMake学习"></a>CMake学习</h2><p><a target="_blank" rel="noopener" href="https://github.com/ttroy50/cmake-examples">https://github.com/ttroy50/cmake-examples</a></p>
<h2 id="LLVM-IR概述"><a href="#LLVM-IR概述" class="headerlink" title="LLVM IR概述"></a>LLVM IR概述</h2><p>LLVM编译过程回顾：</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306142206295.png" alt="image-20230614220618223"></p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153678.png" alt="image-20230614230726941"></p>
<h3 id="什么是LLVM-IR"><a href="#什么是LLVM-IR" class="headerlink" title="什么是LLVM IR?"></a>什么是LLVM IR?</h3><ul>
<li>LLVM IR 是一门低级编程语言，语法类似于汇编</li>
<li>任何高级编程语言（如C++）都可以用 LLVM IR 表示</li>
<li>基于 LLVM IR 可以很方便地进行代码优化(任何编程语言都能统一转换为LLVM IR)</li>
</ul>
<h3 id="LLVM-IR的两种表示方法"><a href="#LLVM-IR的两种表示方法" class="headerlink" title="LLVM IR的两种表示方法"></a>LLVM IR的两种表示方法</h3><p>LLVM IR 共有两种表示方法：</p>
<ul>
<li>人类可以阅读的文本形式，文件后缀为 .ll</li>
<li>易于机器处理的二进制格式，文件后缀为 .bc</li>
</ul>
<p>通过LLVM自带的工具，该两种表示形式也可以互相转换</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153377.png" alt="image-20230615112601095"></p>
<h3 id="LLVM-IR结构"><a href="#LLVM-IR结构" class="headerlink" title="LLVM IR结构"></a>LLVM IR结构</h3><p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153656.png" alt="image-20230615112651678"></p>
<p>源代码被LLVM IR编译后，有如下结构</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151128610.png" alt="image-20230615112800526"></p>
<h4 id="模块-Module"><a href="#模块-Module" class="headerlink" title="模块 Module"></a>模块 Module</h4><p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153281.png" alt="image-20230615113027831"></p>
<ul>
<li>一个源代码文件对应 LLVM IR 中的一个模块。</li>
<li>头部信息包含程序的目标平台，如X86、ARM等等，和一些其他信息。</li>
<li>全局符号包含全局变量、函数的定义与声明。</li>
</ul>
<h4 id="函数-Function"><a href="#函数-Function" class="headerlink" title="函数 Function"></a>函数 Function</h4><p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151130767.png" alt="image-20230615113052721"></p>
<ul>
<li>LLVM IR 中的函数表示源代码中的某个函数。</li>
<li>参数，顾名思义为函数的参数。</li>
<li>一个函数由若干基本块组成，其中函数最先执行的基本块为入口块。</li>
</ul>
<h4 id="基本块-BasicBlock"><a href="#基本块-BasicBlock" class="headerlink" title="基本块 BasicBlock"></a>基本块 BasicBlock</h4><p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153345.png" alt="image-20230615113148285"></p>
<ul>
<li>一个基本块由若干个指令和标签组成。</li>
<li>正常情况下，基本块的最后一条指令为跳转指令(br 或 switch)，或返回指令(retn)，也叫作终结指令(Terminator Instruction)。</li>
<li>其他指令：PHI 指令是一种特殊的指令。</li>
</ul>
<p><strong>LLVM IR和IDA反汇编的结构比较相似。</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153085.png" alt="image-20230615113931786"></p>
<p><strong>基于 LLVM 的混淆，通常是以函数或者比函数更小的单位为基本单位进行混淆的，我们通常更关心函数和基本块这两个结构。</strong></p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151140432.png" alt="image-20230615114034371"></p>
<h4 id="了解-LLVM-IR-的结构是我们学习代码混淆的基础："><a href="#了解-LLVM-IR-的结构是我们学习代码混淆的基础：" class="headerlink" title="了解 LLVM IR 的结构是我们学习代码混淆的基础："></a>了解 LLVM IR 的结构是我们学习代码混淆的基础：</h4><ul>
<li>以函数为基本单位的混淆：控制流平坦化。</li>
<li>以基本块基本单位的混淆：虚假控制流。</li>
<li>以指令为基本单位的混淆：指令替代。</li>
</ul>
<h2 id="LLVM-IR指令"><a href="#LLVM-IR指令" class="headerlink" title="LLVM IR指令"></a>LLVM IR指令</h2><p>总共有六大类指令</p>
<ul>
<li>终结指令 Terminator Instructions</li>
<li>二元运算 Binary Operations</li>
<li>按位二元运算 Bitwise Binary Operations</li>
<li>内存访问和寻址操作 Memory Access and Addressing Operations</li>
<li>类型转换操作 Conversion Operations</li>
<li>其他操作 Other Operations</li>
</ul>
<h3 id="终结指令"><a href="#终结指令" class="headerlink" title="终结指令"></a>终结指令</h3><blockquote>
<p>基本块的最后一个指令，通常为跳转指令或返回指令。<br>跳转到下一个基本快进行执行或从当前执行的函数中返回。</p>
</blockquote>
<h4 id="ret指令"><a href="#ret指令" class="headerlink" title="ret指令"></a>ret指令</h4><blockquote>
<p>return</p>
</blockquote>
<p>函数的返回指令，对应 C&#x2F;C++ 中的 return。</p>
<p>分为有返回值的ret指令和无返回值的ret指令。</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151406265.png" alt="image-20230615140616180"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153882.png" alt="image-20230615140846279"></p>
<h4 id="br指令"><a href="#br指令" class="headerlink" title="br指令"></a>br指令</h4><blockquote>
<p>branch</p>
</blockquote>
<p>跳转指令，分为<code>条件分支</code>和<code>非条件分支</code>。</p>
<ul>
<li>br 是”分支”的英文 branch 的缩写，分为非条件分支和条件分支，对应 C&#x2F;C++ 的 if 语句。</li>
<li>无条件分支类似于x86汇编中的 jmp 指令，条件分支类似于x86汇编中的 jnz, je 等条件跳转指令</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151410426.png" alt="image-20230615141016368"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">br il&lt;cond&gt;, label &lt;iftrue&gt;, label &lt;ifflase&gt;   //i1为条件分支指定的热条件， i1是1位整数，可以理解成一个bool类型，若i1为true，则跳转到第一个基本块；否则跳转到第二个基本块</span><br><span class="line">br label &lt;dest&gt;   //直接跳转到目的基本块</span><br></pre></td></tr></table></figure>

<p>实例</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151410021.png" alt="image-20230615141030979"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Test：</span><br><span class="line">	%cond = icmp eq i32 %a, %b                     //比较ab变量是否相等，返回true or flase</span><br><span class="line">	br i1 %cond, label %IfEqual, label %IfUnequal  //根据%cond判断跳转到哪个基本快</span><br><span class="line">IfEqual:</span><br><span class="line">	ret i32 1</span><br><span class="line">IfUnequal:</span><br><span class="line">	ret i32 0</span><br></pre></td></tr></table></figure>

<h4 id="比较指令"><a href="#比较指令" class="headerlink" title="比较指令"></a>比较指令</h4><blockquote>
<p>比较指令，通常与br指令一起出现</p>
</blockquote>
<ul>
<li>在x86汇编中，条件跳转指令(jnz, je 等)通常与比较指令 cmp, test 等一起出现。</li>
<li>在 LLVM IR 中也有这样一类指令，他们通常与条件分支指令 br 一起出现。</li>
</ul>
<h5 id="icmp指令"><a href="#icmp指令" class="headerlink" title="icmp指令"></a>icmp指令</h5><p>整数或指针的比较指令。</p>
<ul>
<li>条件 cond 可以是 eq（相等）, ne（不相等）, ugt（无符号大于unsigned greater than）等等。</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151426284.png" alt="image-20230615142606230"></p>
<p><strong>实例</strong></p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151426459.png" alt="image-20230615142624401"></p>
<h5 id="fcmp指令"><a href="#fcmp指令" class="headerlink" title="fcmp指令"></a>fcmp指令</h5><p>浮点数的比较指令。</p>
<ul>
<li>条件 cond 可以是 oeq（ordered and equal）, ueq（unordered or equal）, false（必定不成立）等等。</li>
<li>ordered的意思是，两个操作数都不能为 <strong>NAN</strong></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153398.png" alt="image-20230615142930178"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153437.png" alt="image-20230615142943973"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fcmp oeq   //比较两个浮点数是否相等</span><br><span class="line">fcmp one   //比较两个浮点数是否不相等     ordered and not equal</span><br></pre></td></tr></table></figure>

<h4 id="switch指令"><a href="#switch指令" class="headerlink" title="switch指令"></a>switch指令</h4><p>分支指令，可看做是 br 指令的升级版</p>
<ul>
<li>支持的分支更多，但使用也更复杂。对应 C&#x2F;C++ 中的 switch。</li>
<li>根据switch变量值value进行跳转，若value没有对应值，则执行默认的<defaultdest>基本块</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153407.png" alt="image-20230615143630522"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch &lt;intty/变量类型&gt; &lt;value/变量值&gt;， label &lt;defaultdest&gt; [ &lt;intty&gt;&lt;val&gt;, label &lt;dest&gt;...]</span><br></pre></td></tr></table></figure>

<p><strong>实例</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153797.png" alt="image-20230615144436670"></p>
<h3 id="二元运算指令"><a href="#二元运算指令" class="headerlink" title="二元运算指令"></a>二元运算指令</h3><h4 id="add指令"><a href="#add指令" class="headerlink" title="add指令"></a>add指令</h4><p>整数加法指令</p>
<ul>
<li>整数加法指令，对应 C&#x2F;C++ 中的“+”操作符，类似x86汇编中的 add 指令。</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151446829.png" alt="image-20230615144625767"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153763.png" alt="image-20230615144648673"></p>
<h4 id="sub指令"><a href="#sub指令" class="headerlink" title="sub指令"></a>sub指令</h4><p>整数减法指令</p>
<ul>
<li>整数减法指令，对应 C&#x2F;C++ 中的“-”操作符，类似x86汇编中的 sub 指令。</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151447691.png" alt="image-20230615144718653"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153691.png" alt="image-20230615144733080"></p>
<h4 id="mul指令"><a href="#mul指令" class="headerlink" title="mul指令"></a>mul指令</h4><p>整数乘法指令</p>
<ul>
<li>对应 C&#x2F;C++ 中的“*”操作符，类似x86汇编中的 mul 指令。</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151448557.png" alt="image-20230615144855502"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153415.png" alt="image-20230615150722237"></p>
<h4 id="udiv指令"><a href="#udiv指令" class="headerlink" title="udiv指令"></a>udiv指令</h4><p>无符号整数除法指令</p>
<ul>
<li>对应 C&#x2F;C++ 中的“&#x2F;”操作符。如果存在exact关键字，且op1不是op2的倍数，就会出现错误。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153545.png" alt="image-20230615152823994"></p>
<p>加入exact时，需要精确保证op1是op2的倍数，指令才会正常执行</p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153134.png" alt="image-20230615153305650"></p>
<h4 id="sdiv指令"><a href="#sdiv指令" class="headerlink" title="sdiv指令"></a>sdiv指令</h4><p>有符号整数除法指令</p>
<ul>
<li>对应 C&#x2F;C++ 中的“&#x2F;”操作符。</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151534076.png"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153274.png" alt="image-20230615153506036"></p>
<h4 id="urem指令"><a href="#urem指令" class="headerlink" title="urem指令"></a>urem指令</h4><p>无符号整数取余指令</p>
<ul>
<li>对应 C&#x2F;C++ 中的“%”操作符。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153517.png" alt="image-20230615153603497"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153389.png" alt="image-20230615153742092"></p>
<h4 id="srem指令"><a href="#srem指令" class="headerlink" title="srem指令"></a>srem指令</h4><p>有符号整数取余指令</p>
<ul>
<li>对应 C&#x2F;C++ 中的“%”操作符。</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151539086.png" alt="image-20230615153948039"></p>
<p>实例</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151540994.png" alt="image-20230615154003932"></p>
<h3 id="按位二元运算指令"><a href="#按位二元运算指令" class="headerlink" title="按位二元运算指令"></a>按位二元运算指令</h3><blockquote>
<p>逻辑移位统一当成无符号数</p>
<p>算数右移按照原来符号数来决定正负</p>
</blockquote>
<h4 id="shl指令"><a href="#shl指令" class="headerlink" title="shl指令"></a>shl指令</h4><p>整数左移指令</p>
<ul>
<li>对应 C&#x2F;C++ 中的“&lt;&lt;”操作符，类似x86汇编中的 shl 指令。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153042.png" alt="image-20230615154732580"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;result&gt; = shl &lt;ty&gt; &lt;op1&gt;, &lt;op2&gt;    //op1左移op2位</span><br></pre></td></tr></table></figure>

<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153361.png" alt="image-20230615154800064"></p>
<h4 id="lshr指令"><a href="#lshr指令" class="headerlink" title="lshr指令"></a>lshr指令</h4><p>整数逻辑右移指令</p>
<ul>
<li>对应 C&#x2F;C++ 中的“&gt;&gt;”操作符，右移指定位数后在左侧补0。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153017.png" alt="image-20230615155111674"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153121.png" alt="image-20230615155143817"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-2当做无符号数来处理，右移得到16进制数   无符号的右移</span><br></pre></td></tr></table></figure>

<h4 id="ashr指令"><a href="#ashr指令" class="headerlink" title="ashr指令"></a>ashr指令</h4><p>整数算术右移指令</p>
<ul>
<li>右移指定位数后在左侧补符号位（负数的符号位为1，正数的符号位为0）。</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151623894.png" alt="image-20230615162337831"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153316.png" alt="image-20230615162351917"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-2右移1：带符号的右移</span><br></pre></td></tr></table></figure>

<p>逻辑移位：无符号右移<br>算数移位：带符号右移</p>
<h4 id="and指令"><a href="#and指令" class="headerlink" title="and指令"></a>and指令</h4><p>整数按位与运算指令</p>
<ul>
<li>对应 C&#x2F;C++ 中的“&amp;”操作符。</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151627531.png" alt="image-20230615162721472"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153289.png" alt="image-20230615162757274"></p>
<h4 id="or指令"><a href="#or指令" class="headerlink" title="or指令"></a>or指令</h4><p>整数按位或运算指令</p>
<ul>
<li>对应 C&#x2F;C++ 中的“|”操作符。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153662.png" alt="image-20230615162821343"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153172.png" alt="image-20230615162837791"></p>
<h4 id="xor指令"><a href="#xor指令" class="headerlink" title="xor指令"></a>xor指令</h4><p>整数按位异或运算指令</p>
<ul>
<li>对应 C&#x2F;C++ 中的“^”操作符。</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151629469.png" alt="image-20230615162925421"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153304.png" alt="image-20230615162951675"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">变量和&quot;-1&quot;进行异或，相当于把变量按位取反</span><br></pre></td></tr></table></figure>

<h3 id="内存访问和寻址操作指令-重点"><a href="#内存访问和寻址操作指令-重点" class="headerlink" title="内存访问和寻址操作指令(重点)"></a>内存访问和寻址操作指令(重点)</h3><h4 id="静态单赋值"><a href="#静态单赋值" class="headerlink" title="静态单赋值"></a>静态单赋值</h4><ul>
<li>在编译器设计中，静态单赋值（Static Single Assignment, SSA），是 IR 的一种属性。</li>
<li>简单来说，SSA 的特点是：<strong>在程序中一个变量仅能有一条赋值语句</strong>。</li>
<li><strong>LLVM IR 正是基于静态单赋值原则设计的。</strong></li>
</ul>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153084.png" alt="image-20230615192133207"></p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151921072.png" alt="image-20230615192158006"></p>
<p>引例：</p>
<ul>
<li>假设 C++ 也是基于静态单赋值原则的（即一个变量只能被赋值一次），要怎样修改这个 for 循环，使其符合 SSA 原则？</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151930642.png" alt="image-20230615193015602"></p>
<ul>
<li>以下是一种实现方式，也是 LLVM IR 采取的实现方式。在LLVM IR 中也有类似 malloc 和 指针操作 的指令：</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306151930137.png" alt="image-20230615193033070"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">只有第一次给指针i进行了赋值，后面都是对指针指向的区域进行赋值</span><br></pre></td></tr></table></figure>

<h4 id="alloca指令"><a href="#alloca指令" class="headerlink" title="alloca指令"></a>alloca指令</h4><p>内存分配指令</p>
<ul>
<li>在<strong>栈</strong>中分配一块空间并获得指向该空间的指针，类似于 C&#x2F;C++ 中的 malloc 函数。(区别于C语言malloc函数在堆中分配空间)</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153161.png" alt="image-20230615201323778"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type指定了分配什么类型的空间，NumElements指定了分配空间的个数</span><br></pre></td></tr></table></figure>

<p>实例</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306152013703.png" alt="image-20230615201348653"></p>
<h4 id="store指令"><a href="#store指令" class="headerlink" title="store指令"></a>store指令</h4><p>内存存储指令</p>
<ul>
<li>向指针指向的内存中存储数据，类似于 C&#x2F;C++ 中的指针解引用后的赋值操作。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153471.png" alt="image-20230615202610517"></p>
<p>实例</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306152026784.png" alt="image-20230615202650713"></p>
<h4 id="load指令"><a href="#load指令" class="headerlink" title="load指令"></a>load指令</h4><p>内存读取指令</p>
<ul>
<li>从指针指向的内存中读取数据，类似于 C&#x2F;C++ 中的指针解引用操作。</li>
</ul>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306152029949.png" alt="image-20230615202923884"></p>
<h5 id="实例！"><a href="#实例！" class="headerlink" title="实例！"></a><strong>实例！</strong></h5><p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153630.png" alt="image-20230615203041438"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">分配4字节内存</span><br><span class="line">存储3</span><br><span class="line">读取ptr指向的内存，即3</span><br></pre></td></tr></table></figure>

<h3 id="类型转换操作指令"><a href="#类型转换操作指令" class="headerlink" title="类型转换操作指令"></a>类型转换操作指令</h3><h4 id="trunc-…-to指令"><a href="#trunc-…-to指令" class="headerlink" title="trunc … to指令"></a>trunc … to指令</h4><p>截断指令</p>
<ul>
<li>将一种类型的变量截断为另一种类型的变量。对应 C&#x2F;C++ 中大类型向小类型的强制转换（比如 long 强转 int）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102153268.png" alt="image-20230615203341011"></p>
<p>实例</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306152033054.png" alt="image-20230615203353006"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%X = trunc i32 257 to i8      //截断低8位，十进制为1</span><br><span class="line">%Y = trunc i32 123 to i1      //转换为i1类型，即bool类型 保留最低一位，即1或true</span><br></pre></td></tr></table></figure>

<h4 id="zext-…-to指令"><a href="#zext-…-to指令" class="headerlink" title="zext … to指令"></a>zext … to指令</h4><p>零拓展（Zero Extend）指令</p>
<p>将一种类型的变量拓展为另一种类型的变量，高位补0。对应 C&#x2F;C++ 中小类型向大类型的强制转换（比如 int 强转 long）</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306152043925.png" alt="image-20230615204346862"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102154155.png" alt="image-20230615204359349"></p>
<h4 id="sext-to-指令"><a href="#sext-to-指令" class="headerlink" title="sext .. to 指令"></a>sext .. to 指令</h4><p>符号位拓展（Sign Extend）指令</p>
<p>通过复制符号位（最高位）将一种类型的变量拓展为另一种类型的变量。</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102154347.png"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102154865.png" alt="image-20230615204448143"></p>
<h3 id="其他操作指令"><a href="#其他操作指令" class="headerlink" title="其他操作指令"></a>其他操作指令</h3><blockquote>
<p>不太好分类，又比较常见的指令</p>
</blockquote>
<h4 id="phi指令"><a href="#phi指令" class="headerlink" title="phi指令"></a>phi指令</h4><p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102154037.png" alt="image-20230615204702573"></p>
<p><strong>通过引入Φ函数来解决这个问题，Φ函数的值由前驱块决定，这里的Φ函数对应 LLVM IR 中的 phi 指令</strong>：</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306152048108.png" alt="image-20230615204803023"></p>
<ul>
<li><p>phi 指令可以看做是为了解决 SSA 一个变量只能被赋值一次而引起的问题衍生出的指令。</p>
</li>
<li><p>phi 指令的计算结果由 phi 指令所在的基本块的 前驱块 确定</p>
</li>
</ul>
<p><strong>以下是一个用 phi 指令实现for循环的实例</strong>：</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306152051954.png" alt="image-20230615205106878"></p>
<h4 id="select-指令"><a href="#select-指令" class="headerlink" title="select 指令"></a>select 指令</h4><ul>
<li>select 指令类似于 C&#x2F;C++ 中的三元运算符”… ? … : …”</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102154976.png" alt="image-20230615205206571"></p>
<p>实例</p>
<p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202306152052518.png" alt="image-20230615205227447"></p>
<h4 id="call指令"><a href="#call指令" class="headerlink" title="call指令"></a>call指令</h4><ul>
<li>call 指令用来调用某个函数，对应 C&#x2F;C++ 中的函数调用，与x86汇编中的 call 指令类似</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102154530.png" alt="image-20230615205250731"></p>
<p>实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102154909.png" alt="image-20230615205303138"></p>
<h2 id="一个简单的LLVM-IR阅读与分析-了解结构"><a href="#一个简单的LLVM-IR阅读与分析-了解结构" class="headerlink" title="一个简单的LLVM IR阅读与分析(了解结构)"></a>一个简单的LLVM IR阅读与分析(了解结构)</h2><p><img src="https://image-1311319331.cos.ap-beijing.myqcloud.com/image/202307021135314.png" alt="image-20230702113538997"></p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102154212.png" alt="image-20230702113732000"></p>
<p><img src="https://cdn.jsdelivr.net/gh/SlientRainyDay/image@main/image/202401102154174.png" alt="image-20230702113810314"></p>
<h3 id="LLVM-IR-for循环分析"><a href="#LLVM-IR-for循环分析" class="headerlink" title="LLVM IR  for循环分析"></a>LLVM IR  for循环分析</h3><p>for循环的实现方法</p>
<ul>
<li>内存存取指令</li>
<li>phi</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>看雪 《LLVM与代码混淆技术》</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2024/01/10/llvm%E5%9F%BA%E7%A1%80/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/llvm/" rel="tag">llvm</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/01/10/python%E4%BB%A3%E7%A0%81%E4%BF%9D%E6%8A%A4%E5%8F%8A%E7%A0%B4%E8%A7%A3-1/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            python代码保护及破解(上)
          
        </div>
      </a>
    
    
      <a href="/2024/01/09/hello-world/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Hello World</div>
      </a>
    
  </nav>

  
   
  
    
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2024
        <i class="ri-heart-fill heart_icon"></i> Rain&#39;s Blog
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Rain&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>